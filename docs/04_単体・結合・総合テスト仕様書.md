# 04. 単体・結合・総合テスト仕様書

## Bistro Lumiere - レストラン座席予約システム

---

## 1. テスト方針

### テストピラミッド

```
         △ 総合テスト（手動）
        △△△ 結合テスト（自動: @WebMvcTest）
      △△△△△ 単体テスト（自動: JUnit5 + Mockito）
```

> **テストは「保険」です。**
> コードを変更するたびに「壊れていないか」を手動で確認するのは大変です。
> 自動テストがあれば、`mvn test` の1コマンドで数秒のうちに全パターンを検証できます。
> これを「リグレッション（回帰）テスト」と呼び、安心してコードを改修できる基盤になります。

---

## 2. 単体テスト仕様

### 対象クラス: `ReservationService`

テストツール: JUnit 5 + Mockito + AssertJ

| テストID | テスト名 | テスト観点 | 期待結果 |
|---------|---------|-----------|---------|
| UT-01 | 空席あり → 予約作成成功 | 正常系: 残席がある状態での予約 | 予約が作成され、CONFIRMEDステータスが返る |
| UT-02 | 満席 → 例外スロー | 異常系: 5組予約済みの状態 | BusinessException("FULLY_BOOKED")がスローされる |
| UT-03 | 過去日付 → 例外スロー | 異常系: 昨日の日付 | BusinessException("PAST_DATE_NOT_ALLOWED")がスローされる |
| UT-04 | 1ヶ月超先 → 例外スロー | 異常系: 31日後の日付 | BusinessException("TOO_FAR_IN_FUTURE")がスローされる |
| UT-05 | 残り1席（境界値）→ 作成成功 | 正常系: 4組予約済みで残り1組の状態 | 予約が作成される（境界値テスト） |
| UT-06 | キャンセル正常完了 | 正常系: 確定済み予約のキャンセル | CANCELLEDステータスが返る |
| UT-07 | 存在しないID → 例外スロー | 異常系: 存在しない予約IDのキャンセル | BusinessException("RESERVATION_NOT_FOUND")がスローされる |
| UT-08 | キャンセル済みを再キャンセル | 異常系: すでにキャンセルされた予約 | BusinessException("ALREADY_CANCELLED")がスローされる |
| UT-09 | 空席確認: 予約なし | 正常系: 予約ゼロの状態 | 残り5席が返される |
| UT-10 | 空席確認: 満席 | 正常系: 5組予約済みの状態 | 残り0席が返される |
| UT-11 | 空席確認: 3組予約済み | 正常系: 3組予約済みの状態 | 残り2席が返される |

---

## 3. 結合テスト仕様

### 対象クラス: `ReservationController`

テストツール: @WebMvcTest + MockMvc + @MockBean

| テストID | HTTP | パス | シナリオ | 期待HTTPステータス | 期待レスポンス |
|---------|------|------|---------|-----------------|--------------|
| IT-01 | POST | /api/reservations | 有効なリクエスト | 201 Created | idとCONFIRMEDステータスを含むJSON |
| IT-02 | POST | /api/reservations | 名前が空文字 | 400 Bad Request | errorCode=VALIDATION_FAILED |
| IT-03 | POST | /api/reservations | 人数が5名（上限超過） | 400 Bad Request | errorCode=VALIDATION_FAILED |
| IT-04 | POST | /api/reservations | 満席（Serviceが例外スロー） | 409 Conflict | errorCode=FULLY_BOOKED |
| IT-05 | GET | /api/reservations | 全件取得 | 200 OK | 予約リスト（2件） |
| IT-06 | GET | /api/reservations | 予約なし | 200 OK | 空のリスト[] |
| IT-07 | DELETE | /api/reservations/1 | 正常キャンセル | 200 OK | status=CANCELLEDのJSON |
| IT-08 | DELETE | /api/reservations/999 | 存在しないID | 404 Not Found | errorCode=RESERVATION_NOT_FOUND |

---

## 4. 総合テスト観点（手動テスト）

実際にアプリを起動し、ブラウザ操作でエンドツーエンドを確認します。

| テストID | カテゴリ | テストシナリオ | 確認観点 |
|---------|---------|--------------|---------|
| ST-01 | 正常系 | 予約作成→一覧で確認→キャンセル | 一連のフローが正常に動作すること |
| ST-02 | 境界値 | 満席状態で予約を試みる | 409エラーが適切なメッセージで返ること |
| ST-03 | UX | API通信中にローディングが表示される | Neon遅延時でもUIが適切に表示されること |
| ST-04 | セキュリティ | フォームに `<script>alert(1)</script>` を入力 | スクリプトが実行されず文字列として表示される（XSS対策） |
| ST-05 | バリデーション | 必須項目を空でフォーム送信 | 各フィールドにエラーメッセージが表示される |
| ST-06 | レスポンシブ | スマートフォン幅（375px）で表示 | UIが崩れず操作できること |

---

## 5. テスト実行結果（エビデンス）

> このセクションには、`mvn test` を実行した際の実際の CLIログを記録します。
> AIはスクリーンショットを撮れないため、このCLIログが公式な「テスト通過証跡」です。

---

### 実行コマンド

```bash
cd backend && mvn test
```

### 実行結果ログ（実際の実行証跡）

```
[INFO] Scanning for projects...
[INFO]
[INFO] -------------------< com.bistrolumiere:reservation >--------------------
[INFO] Building bistro-lumiere-reservation 0.0.1-SNAPSHOT
[INFO]   from pom.xml
[INFO] --------------------------------[ jar ]---------------------------------
[INFO]
[INFO] --- resources:3.3.1:resources (default-resources) @ reservation ---
[INFO] Copying 1 resource from src\main\resources to target\classes
[INFO] Copying 0 resource from src\main\resources to target\classes
[INFO]
[INFO] --- compiler:3.11.0:compile (default-compile) @ reservation ---
[INFO] Nothing to compile - all classes are up to date
[INFO]
[INFO] --- resources:3.3.1:testResources (default-testResources) @ reservation ---
[INFO] Copying 1 resource from src\test\resources to target\test-classes
[INFO]
[INFO] --- compiler:3.11.0:testCompile (default-testCompile) @ reservation ---
[INFO] Nothing to compile - all classes are up to date
[INFO]
[INFO] --- surefire:3.1.2:test (default-test) @ reservation ---
[INFO] Using auto detected provider org.apache.maven.surefire.junitplatform.JUnitPlatformProvider
[INFO]
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running com.bistrolumiere.reservation.controller.ReservationControllerTest
[INFO] Running com.bistrolumiere.reservation.controller.ReservationControllerTest$DeleteReservation
[INFO] Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 3.650 s -- in com.bistrolumiere.reservation.controller.ReservationControllerTest$DeleteReservation
[INFO] Running com.bistrolumiere.reservation.controller.ReservationControllerTest$GetAllReservations
[INFO] Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.043 s -- in com.bistrolumiere.reservation.controller.ReservationControllerTest$GetAllReservations
[INFO] Running com.bistrolumiere.reservation.controller.ReservationControllerTest$PostReservation
[INFO] Tests run: 4, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.192 s -- in com.bistrolumiere.reservation.controller.ReservationControllerTest$PostReservation
[INFO] Tests run: 0, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 4.203 s -- in com.bistrolumiere.reservation.controller.ReservationControllerTest
[INFO] Running com.bistrolumiere.reservation.service.ReservationServiceTest
[INFO] Running com.bistrolumiere.reservation.service.ReservationServiceTest$GetAvailableSeats
[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.372 s -- in com.bistrolumiere.reservation.service.ReservationServiceTest$GetAvailableSeats
[INFO] Running com.bistrolumiere.reservation.service.ReservationServiceTest$CancelReservation
[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.037 s -- in com.bistrolumiere.reservation.service.ReservationServiceTest$CancelReservation
[INFO] Running com.bistrolumiere.reservation.service.ReservationServiceTest$CreateReservation
[INFO] Tests run: 5, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.022 s -- in com.bistrolumiere.reservation.service.ReservationServiceTest$CreateReservation
[INFO] Tests run: 0, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.439 s -- in com.bistrolumiere.reservation.service.ReservationServiceTest
[INFO]
[INFO] Results:
[INFO]
[INFO] Tests run: 19, Failures: 0, Errors: 0, Skipped: 0
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  7.242 s
[INFO] Finished at: 2026-02-20T18:51:04+09:00
[INFO] ------------------------------------------------------------------------
```

### テスト結果サマリー

| クラス | テストグループ | テスト数 | 成功 | 失敗 | エラー | スキップ |
|--------|-------------|---------|------|------|-------|---------|
| ReservationControllerTest | DeleteReservation | 2 | 2 | 0 | 0 | 0 |
| ReservationControllerTest | GetAllReservations | 2 | 2 | 0 | 0 | 0 |
| ReservationControllerTest | PostReservation | 4 | 4 | 0 | 0 | 0 |
| ReservationServiceTest | GetAvailableSeats | 3 | 3 | 0 | 0 | 0 |
| ReservationServiceTest | CancelReservation | 3 | 3 | 0 | 0 | 0 |
| ReservationServiceTest | CreateReservation | 5 | 5 | 0 | 0 | 0 |
| **合計** | - | **19** | **19** | **0** | **0** | **0** |

**結果: BUILD SUCCESS ✓**

---

## 6. テスト環境情報

| 項目 | 内容 |
|------|------|
| Java バージョン | Java 17 |
| Spring Boot バージョン | 3.2.5 |
| テストDB | H2 インメモリ（application-test.yml） |
| 実行日時 | 2026-02-20 |
| 実行環境 | Windows 11 Pro |
